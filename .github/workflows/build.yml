name: Build DKMS APT Package

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up QEMU for ARM
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm,arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build in Debian container
        uses: addnab/docker-run-action@v3
        with:
          image: debian:bullseye
          options: -v ${{ github.workspace }}:/workspace
          run: |
            apt-get update
            apt-get install -y build-essential debhelper dkms device-tree-compiler wget
            # Download Raspberry Pi kernel headers (example for 5.10)
            wget -qO- https://archive.raspberrypi.org/debian/pool/main/r/raspberrypi-firmware/raspberrypi-kernel-headers_1.20230405-1_armhf.deb > headers.deb
            dpkg -i headers.deb || true
            cd /workspace
            dtc -@ -I dts -O dtb -o pico-spi.dtbo pico-spi-overlay.dts
            dpkg-buildpackage -us -uc

      - name: Install cross-compiler and tools
        run: |
          apt-get update
          apt-get install -y gcc-arm-linux-gnueabihf make bc bison flex libssl-dev device-tree-compiler wget

      - name: Download Raspberry Pi kernel source
        id: kernel_source
        run: |
          export KERNEL_VERSION=6.1.21
          wget https://github.com/raspberrypi/linux/archive/refs/tags/raspberrypi-kernel_${KERNEL_VERSION}.tar.gz -O kernel.tar.gz
          tar xzf kernel.tar.gz
          mv linux-raspberrypi-kernel_${KERNEL_VERSION} rpi-linux

      # Use ${{ github.workspace }}/rpi-linux as the kernel source for all build steps

      - name: Copy sources for packaging
        run: |
          mkdir -p deb-src/usr/src/pico-spi
          cp pico_spi.c Makefile pico-spi-overlay.dts deb-src/usr/src/pico-spi/

      - name: Compile Device Tree Overlay for packaging
        run: |
          dtc -@ -I dts -O dtb -o deb-src/usr/src/pico-spi/pico-spi.dtbo deb-src/usr/src/pico-spi/pico-spi-overlay.dts

      - name: Cross-compile kernel module for packaging
        run: |
          export KERNEL_SRC=${{ github.workspace }}/rpi-linux
          export ARCH=arm
          export CROSS_COMPILE=arm-linux-gnueabihf-
          make -C $KERNEL_SRC M=${{ github.workspace }}/deb-src/usr/src/pico-spi ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE modules
        working-directory: ${{ github.workspace }}

      - name: Package sources as deb
        run: |
          cd deb-src
          tar czf ../pico-spi-src.tar.gz .

      - name: Upload source package artifact
        uses: actions/upload-artifact@v4
        with:
          name: pico-spi-source
          path: pico-spi-src.tar.gz
