name: Build DKMS APT Package

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build in Debian container
        uses: addnab/docker-run-action@v3
        with:
          image: debian:bullseye
          options: -v ${{ github.workspace }}:/workspace
          run: |
            apt-get update
            apt-get install -y tar
            cd /workspace
            # No compilation, just packaging sources

      # Use ${{ github.workspace }}/rpi-linux as the kernel source for all build steps

      - name: Copy sources for packaging
        run: |
          mkdir -p deb-src/usr/src/pico-spi
          cp pico_spi.c Makefile pico-spi-overlay.dts deb-src/usr/src/pico-spi/

      - name: Package sources as deb
        run: |
          cd deb-src
          tar czf ../pico-spi-src.tar.gz .

      - name: Upload source package artifact
        uses: actions/upload-artifact@v4
        with:
          name: pico-spi-source
          path: pico-spi-src.tar.gz
