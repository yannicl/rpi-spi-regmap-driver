name: Build DKMS APT Package

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build Debian package
        run: |
          # Create package directory structure
          mkdir -p pico-spi-dkms/DEBIAN
          mkdir -p pico-spi-dkms/usr/src/pico-spi
          
          # Copy source files
          cp pico_spi.c Makefile pico-spi-overlay.dts pico-spi-dkms/usr/src/pico-spi/
          
          # Copy control files
          cp debian/control pico-spi-dkms/DEBIAN/
          cp debian/changelog pico-spi-dkms/DEBIAN/
          cp debian/copyright pico-spi-dkms/DEBIAN/
          
          # Copy maintainer scripts if they exist
          [ -f debian/postinst ] && cp debian/postinst pico-spi-dkms/DEBIAN/ && chmod 755 pico-spi-dkms/DEBIAN/postinst
          [ -f debian/prerm ] && cp debian/prerm pico-spi-dkms/DEBIAN/ && chmod 755 pico-spi-dkms/DEBIAN/prerm
          
          # Build the .deb package
          dpkg-deb --build pico-spi-dkms pico-spi.deb

      - name: Upload Debian package artifact
        uses: actions/upload-artifact@v4
        with:
          name: pico-spi-deb
          path: pico-spi.deb
